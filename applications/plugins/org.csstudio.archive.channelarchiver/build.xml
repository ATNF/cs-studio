<!-- Ant build file.

     This is used for building a standalone channelarchiver.jar,
     for use with Java code outside of Eclipse.
     It does not use the Eclipse Plugin mechanism,
     nor the org.csstudio.archive.ArchiveImplementationRegistry.
     
     Kay Kasemir
  -->
<project name="project" default="all" basedir=".">
    <!-- Adjust these to match your installation. -->
    <property name="eclipse_dir" value="/Users/kasemir/MacStuff/Eclipse/eclipse32/eclipse" />
    <property name="plug_dir" value="${eclipse_dir}/plugins" />
    <property name="junit_jar" value="${plug_dir}/org.junit_3.8.1/junit.jar" />
    <property name="css_platform" value="../org.csstudio.platform/src" />
    <property name="pv" value="../org.csstudio.utility.pv/src" />
    <property name="archive" value="../org.csstudio.archive/src" />

    <!-- Nothing to adjust from here on. -->
    <property name="xmlrpc_jar" value="lib/xmlrpc-2.0.1/xmlrpc-2.0.1.jar" />
    <property name="commons_jar" value="lib/commons-codec/commons-codec-1.3.jar" />
        <property name="classpath" value="${junit_jar}:${xmlrpc_jar}:${commons_jar}" />

    <target name="all" description="Build everything">
        <antcall target="channelarchiver_jar"/>
        <antcall target="clean"/>
    </target>

    <target name="compile" description="compile everything">
        <echo>Classpath: ${classpath}</echo>
        <mkdir dir="build"/>
        <echo>Compiling ${css_platform}, ${pv} and ${archive} locally</echo>
        <javac srcdir="${css_platform}"
                includes="org/csstudio/platform/util/ITimestamp.java,
        	              org/csstudio/platform/util/TimestampFactory.java,
        	              org/csstudio/platform/internal/util/Timestamp.java"
                destdir="build" classpath="${classpath}"/>
        <javac srcdir="${pv}"
                includes="org/csstudio/value/*.java"
                destdir="build" classpath="${classpath}"/>
        <javac srcdir="${archive}"
                includes="org/csstudio/archive/ArchiveInfo.java,
        	              org/csstudio/archive/ArchiveServer.java,
                          org/csstudio/archive/ArchiveValues.java,
                          org/csstudio/archive/IArchiveImplementation.java,
                          org/csstudio/archive/Messages.java,
                          org/csstudio/archive/NameInfo.java,
            			  org/csstudio/archive/crawl/*.java,
			              org/csstudio/archive/util/*.java"
                destdir="build" classpath="${classpath}"/>
        <echo>Compiling local sources</echo>
        <javac srcdir="src" 
                includes="org/csstudio/archive/*.java,org/csstudio/archive/channelarchiver/**,org/csstudio/archive/crawl/**,org/csstudio/archive/util/**"
                destdir="build" classpath="${classpath}"/>
    </target>

    <target name="channelarchiver_jar" depends="compile"
     description="Create channelarchiver.jar">
        <jar destfile="channelarchiver.jar">
                <!-- Add the 'local' classes. -->
            <fileset dir="build" includes="**/*.class"/>
                <!-- Add classes from dependent jar files. -->
                <zipfileset src="${junit_jar}" includes="**/*.class"/>
                <zipfileset src="${xmlrpc_jar}" includes="**/*.class"/>
                <zipfileset src="${commons_jar}" includes="**/*.class"/>
                <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                        <!-- <attribute name="Main-Class" value="org.csstudio....Main"/> -->
            </manifest>
        </jar>
    </target>

    <target name="clean" description="remove intermediate files">
        <echo>Removing the 'build' subdir, leaving the created jar file behind</echo>
        <delete dir="build"/>
    </target>

    <target name="matlab_arch_zip" depends="channelarchiver_jar"
     description="Create matlab_arch.zip">
        <zip destfile="matlab_arch.zip">
                <fileset file="channelarchiver.jar" />
                <fileset dir="matlab" />
        </zip>
    </target>
</project>